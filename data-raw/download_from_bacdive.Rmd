# Code to prepare datasets

Also saves a large type strain list for later use if needed

Pro-tip to search for a given bacdive ID: list.filter(list_holder, General$`BacDive-ID` == "141146")

```{r libraries}
library(BacDive)
library(tidyverse)
library(usethis)
library(magrittr)
library(here)
library(bacphene)
library(rlist)
```

```{r download from bacdive if needed}

# This can take a few minutes to download all the type strain data from bacdive.org
if (file.exists(here("data-raw/type_strain_large_list.rda"))) {
  list_holder <- read_rds(here("data-raw/type_strain_large_list.rda"))
} else {
  credentials = Sys.getenv(c("DSMZ_API_USER", "DSMZ_API_PASSWORD"))
  
  bacdive <- open_bacdive(credentials[[1L]], credentials[[2L]])
  
  full_list <-
    read_csv(
      here("data-raw/full_list_of_bacteria_from_bacdive_20211027.csv"),
      skip = 2,
      show_col_types = FALSE
    )
  # this was downloaded here: https://bacdive.dsmz.de/advsearch?filter-group%5B1%5D%5Bgroup-condition%5D=OR&filter-group%5B1%5D%5Bfilters%5D%5B1%5D%5Bfield%5D=Domain&filter-group%5B1%5D%5Bfilters%5D%5B1%5D%5Bfield-option%5D=contains&filter-group%5B1%5D%5Bfilters%5D%5B1%5D%5Bfield-value%5D=Bacteria&filter-group%5B1%5D%5Bfilters%5D%5B1%5D%5Bfield-validation%5D=strains-domain-1
  
  type_strains <- full_list %>%
    filter(is_type_strain_header == 1)
  
  # If you try to download more than 100 you get warnings and errors like this one:
  # Warning message:
  #   In download_json_with_retry(url, object) :
  #   [API] title: BacDive API error; code: 400; message: You exceeded the maximum amount of 100 ids per request.
  
  list_holder <- list()
  
  i = 1
  
  for (i in seq(1, length(type_strains$ID), 100)) {
    if (i + 99 > length(type_strains$ID)) {
      k = length(type_strains$ID) #since the last block would include NA's otherwise
    } else {
      k = i + 99
    }
    temp_list <- fetch(bacdive, type_strains$ID[i:k])
    list_holder <- c(list_holder, temp_list$results)
  }
  # have this so we know when the data was downloaded
  attr(list_holder, "date_downloaded") <- Sys.Date()
  write_rds(list_holder, here("data-raw/type_strain_large_list.rda")) #so if we re-run the script we don't have to keep GETing data from bacdive
}
```

```{r test set}
#for unit tests
# random_set <- sample(seq(1,13572), 10)
random_set <- c(2065L, 558L, 11208L, 6966L, 3485L, 12912L, 12046L, 3912L, 2530L, 8477L)
test_list <- list()
for (i in random_set) {
  test_list <- list.append(test_list, list_holder[[i]])
}
attr(test_list, "date_downloaded") <- attr(list_holder, "date_downloaded")
write_rds(test_list, file = here("tests/testthat/test_data.rda"))
```


Now we want to extract the important bits (gram stain, oxygen tolerance, abx sensitivity / resistance, and urease activity)

## bacdive_morphology

Cell morphology -> gram_stain

```{r}

bacdive_morphology <- getMorphology(list_holder)

usethis::use_data(bacdive_morphology, overwrite = TRUE)

```

## bacdive_oxygen

Oxygen tolerance -> aerobic_status

```{r}

bacdive_oxygen <- getOxygen(list_holder)

usethis::use_data(bacdive_oxygen, overwrite = TRUE)

```

## bacdive_phenotypes

Here we are combining the essential parts of `bacdive_morphology` and `bacdive_oxygen` to get a dataframe that is compatible with the [abxidx package](https://github.com/PennChopMicrobiomeProgram/abxidx)

```{r}

bacdive_phenotypes <- getPhenotypes(morphology_df = bacdive_morphology, oxygen_df = bacdive_oxygen)

usethis::use_data(bacdive_phenotypes, overwrite = TRUE)

# maybe concatenate multiple entries?
# summarise(gram_stain = paste(gram_stain, collapse = ", "),
#           aerobic_status = paste(aerobic_status, collapse = ", "))

# If we want to exactly match the values for abxidx
# bacdive_phenotypes <- bacdive_phenotypes %>%
#   mutate(gram_stain = case_when(gram_stain %in% "positive" ~ "Gram-positive",
#                                 gram_stain %in% "negative" ~ "Gram-negative"))
# this turns all the "variable" values for gram_stain into NA's


```

## bacdive_susceptibility

```{r}
bacdive_susceptibility <- tibble()
for (i in 1:length(list_holder)) {
  abx_df <-
    list_holder[[i]]$`Physiology and metabolism`$`antibiotic resistance`
  my_df <- tibble()
  
  if (!is.null(abx_df)) {
    if (!is.null(names(abx_df))) {
      #for when you have a single antibiotic entry since a longer list will not have a `names` attribute
      my_df[1, "ID"] <- list_holder[[i]]$General$`BacDive-ID`
      my_df[1, "taxon"] <-
        list_holder[[i]]$`Name and taxonomic classification`$species
      my_df[1, "rank"] <- "Species"
      my_df[1, "antibiotic"] <- abx_df$metabolite
      resistant <- abx_df$`is resistant`
      #there is probably a smarter way to do this
      sensitive <- abx_df$`is sensitive`
      if (!is.null(resistant)) {
        if (resistant %in% "yes") {
          #you can not test both at once because R will error
          my_df[1, "value"] <- "resistant"
        }
      }
      if (!is.null(sensitive)) {
        if (sensitive %in% "yes") {
          my_df[1, "value"] <- "susceptible"
        }
      }
    } else {
      for (j in 1:length(abx_df)) {
        my_df[j, "ID"] <- list_holder[[i]]$General$`BacDive-ID`
        my_df[j, "taxon"] <-
          list_holder[[i]]$`Name and taxonomic classification`$species
        my_df[j, "rank"] <- "Species"
        my_df[j, "antibiotic"] <- abx_df[[j]]$metabolite
        resistant <- abx_df[[j]]$`is resistant`
        sensitive <- abx_df[[j]]$`is sensitive`
        if (!is.null(resistant)) {
          if (resistant %in% "yes") {
            #you can not test both at once because R will error
            my_df[j, "value"] <- "resistant"
          }
        }
        if (!is.null(sensitive)) {
          if (sensitive %in% "yes") {
            my_df[j, "value"] <- "susceptible"
          }
        }
      }
    }
  }
  
  bacdive_susceptibility <- bind_rows(bacdive_susceptibility, my_df)
  
}

attr(bacdive_susceptibility, "date_downloaded") <-
  attr(list_holder, "date_downloaded")
usethis::use_data(bacdive_susceptibility, overwrite = TRUE)
```

## bacdive_enzymes

```{r}
bacdive_enzymes <- tibble()
for (i in 1:length(list_holder)) {
  if (!is.null(list_holder[[i]]$`Physiology and metabolism`$enzymes)) {
    ref_df <-
      bind_rows(list_holder[[i]]$Reference) %>% select(`@id`, `doi/url`)
    enzyme_df <-
      bind_rows(list_holder[[i]]$`Physiology and metabolism`$enzymes) %>%
      mutate(
        ID = list_holder[[i]]$General$`BacDive-ID`,
        taxon = list_holder[[i]]$`Name and taxonomic classification`$species,
        rank = "Species"
      ) %>%
      left_join(ref_df, by = c("@ref" = "@id"))
    bacdive_enzymes <- bind_rows(bacdive_enzymes, enzyme_df)
  }
}

bacdive_enzymes %<>%
  select(ID, taxon, rank, activity, value, ec, doi = `doi/url`)
attr(bacdive_enzymes, "date_downloaded") <-
  attr(list_holder, "date_downloaded")
usethis::use_data(bacdive_enzymes, overwrite = TRUE)
```

## Shen2021

```{r}
Shen2021 <- read_csv("data-raw/Shen2021.csv", show_col_types = FALSE)
usethis::use_data(Shen2021, overwrite = TRUE)
```

# The end

