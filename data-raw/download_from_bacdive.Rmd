# Code to prepare datasets

Also saves a large type strain list for later use if needed

Pro-tip to search for a given bacdive ID: list.filter(list_holder, General$`BacDive-ID` == "141146")

```{r libraries}
library(BacDive)
library(tidyverse)
library(usethis)
library(magrittr)
library(here)
library(bacphene)
library(rlist)
```

```{r download typestrains}

list_holder <- getStrains(typestrain_only = F)

```

```{r test set, eval=FALSE, include=FALSE}
#for unit tests
# random_set <- sample(seq(1,length(list_holder)), 10)
random_set <- c(46551L, 376L, 78203L, 51907L, 20151L, 41583L, 11608L, 36060L, 38371L, 6841L)
test_list <- list()
for (i in random_set) {
  test_list <- list.append(test_list, list_holder[[i]])
}
test_list <- list.append(test_list, getStrainLocal(list_holder, query = "Acidicapsa dinghuensis", typestrain_only = T)[[1]]) #for testing getAbx
test_list <- list.append(test_list, getStrainLocal(list_holder, query = "Acinetobacter calcoaceticus", typestrain_only = T)[[2]]) #for testing getAbx (antibiogram)
test_list <- list.append(test_list, getStrainLocal(list_holder, query = 21374, typestrain_only = F)[[1]]) #for testing getAbx
test_list <- list.append(test_list, getStrainLocal(list_holder, query = 280, typestrain_only = F)[[1]]) #for testing getAbx
test_list <- list.append(test_list, getStrainLocal(list_holder, query = 8094, typestrain_only = F)[[1]]) #for testing getAbx
test_list <- list.append(test_list, getStrainLocal(list_holder, query = 159751, typestrain_only = F)[[1]]) #for testing getAbx
test_list <- list.append(test_list, getStrainLocal(list_holder, query = 158420, typestrain_only = F)[[1]]) #for testing getAbx

test_list <- list.append(test_list, getStrainLocal(list_holder, query = "Abyssibacter profundi", typestrain_only = T)[[1]]) #for testing getEnzymes
test_list <- list.append(test_list, getStrainLocal(list_holder, query = "Bacteroides fragilis", typestrain_only = T)[[1]])
test_list <- list.append(test_list, getStrainLocal(list_holder, query = "Bacteroides fragilis", typestrain_only = F)[[2]]) #for testing getStrainLocal and having multiple strains of the same species

attr(test_list, "date_downloaded") <- attr(list_holder, "date_downloaded")
write_rds(test_list, file = here("tests/testthat/test_data.rda"))
```


Now we want to extract the important bits (gram stain, oxygen tolerance, abx sensitivity / resistance, and urease activity)

## bacdive_morphology

Cell morphology -> gram_stain

```{r}

bacdive_morphology <- getMorphology(list_holder)

usethis::use_data(bacdive_morphology, overwrite = TRUE)

```

## bacdive_oxygen

Oxygen tolerance -> aerobic_status

```{r}

bacdive_oxygen <- getOxygen(list_holder)

usethis::use_data(bacdive_oxygen, overwrite = TRUE)

```

## bacdive_phenotypes

Here we are combining the essential parts of `bacdive_morphology` and `bacdive_oxygen` to get a dataframe that is compatible with the [abxidx package](https://github.com/PennChopMicrobiomeProgram/abxidx).

```{r}

bacdive_phenotypes <- getPhenotypes(morphology_df = bacdive_morphology, oxygen_df = bacdive_oxygen)

usethis::use_data(bacdive_phenotypes, overwrite = TRUE)

# maybe concatenate multiple entries?
# summarise(
#   gram_stain = paste(gram_stain, collapse = ", "),
#   aerobic_status = paste(aerobic_status, collapse = ", "),
#   ID = paste(ID, collapse = ", ")
# )

# If we want to exactly match the values for abxidx
# bacdive_phenotypes <- bacdive_phenotypes %>%
#   mutate(gram_stain = case_when(gram_stain %in% "positive" ~ "Gram-positive",
#                                 gram_stain %in% "negative" ~ "Gram-negative"))
# this turns all the "variable" values for gram_stain into NA's


```

## bacdive_susceptibility

`bacdive_abx` contains antibiotics information from bacdive, including multiple strains and details for antibiotic sensitivity / resistance. Antibiotics information that is in the "antibiogram" format is in the `bacdive_antibiogram` data frame. `bacdive_susceptibility` combines the preceding two data frames and contains a simplified version that gets the most common values for each taxon. `bacdive_susceptibility` is compatible with the [abxidx package](https://github.com/PennChopMicrobiomeProgram/abxidx).

```{r}

bacdive_abx <- getAbx(list_holder)
bacdive_antibiogram <- getAntibiogram(list_holder)

# strains_with_abx <- bacdive_abx %>% 
#   select(ID, taxon, rank, type_strain) %>%
#   bind_rows(bacdive_antibiogram %>% select(ID, taxon, rank, type_strain)) %>%
#   distinct() %>%
#   mutate(abx_info = if_else(ID %in% bacdive_abx$ID, T, F)) %>%
#   mutate(antibiogram = if_else(ID %in% bacdive_antibiogram$ID, T, F))

bacdive_combined_abx <- bind_rows(bacdive_abx, bacdive_antibiogram)

bacdive_susceptibility <- getSimplifiedAbx(data = bacdive_combined_abx, extra_info = F, most_common = T, remove_unknown = T)

usethis::use_data(bacdive_abx, overwrite = TRUE)
usethis::use_data(bacdive_antibiogram, overwrite = TRUE)
usethis::use_data(bacdive_susceptibility, overwrite = TRUE)

```

## bacdive_enzymes

```{r}

bacdive_enzymes <- getEnzymes(list_holder, most_common = T, remove_unknown = T)

usethis::use_data(bacdive_enzymes, overwrite = TRUE)

```

## Shen2021

```{r}

Shen2021 <- read_csv(here("data-raw/Shen2021.csv"), show_col_types = FALSE)

usethis::use_data(Shen2021, overwrite = TRUE)

```

# The end

