# Code to prepare datasets

Also saves a large type strain list for later use if needed

Pro-tip to search for a given bacdive ID: list.filter(list_holder, General$`BacDive-ID` == "141146")

```{r libraries}
library(BacDive)
library(tidyverse)
library(usethis)
library(magrittr)
library(here)
library(bacphene)
library(rlist)
```

```{r download typestrains}

list_holder <- getStrains(typestrain_only = F)

```

```{r test set, eval=FALSE, include=FALSE}
#for unit tests
# random_set <- sample(seq(1,length(list_holder)), 10)
random_set <- c(46551L, 376L, 78203L, 51907L, 20151L, 41583L, 11608L, 36060L, 38371L, 6841L)
test_list <- list()
for (i in random_set) {
  test_list <- list.append(test_list, list_holder[[i]])
}
attr(test_list, "date_downloaded") <- attr(list_holder, "date_downloaded")
write_rds(test_list, file = here("tests/testthat/test_data.rda"))
```


Now we want to extract the important bits (gram stain, oxygen tolerance, abx sensitivity / resistance, and urease activity)

## bacdive_morphology

Cell morphology -> gram_stain

```{r}

bacdive_morphology <- getMorphology(list_holder)

usethis::use_data(bacdive_morphology, overwrite = TRUE)

```

## bacdive_oxygen

Oxygen tolerance -> aerobic_status

```{r}

bacdive_oxygen <- getOxygen(list_holder)

usethis::use_data(bacdive_oxygen, overwrite = TRUE)

```

## bacdive_phenotypes

Here we are combining the essential parts of `bacdive_morphology` and `bacdive_oxygen` to get a dataframe that is compatible with the [abxidx package](https://github.com/PennChopMicrobiomeProgram/abxidx)

```{r}

bacdive_phenotypes <- getPhenotypes(morphology_df = bacdive_morphology, oxygen_df = bacdive_oxygen)

usethis::use_data(bacdive_phenotypes, overwrite = TRUE)

# maybe concatenate multiple entries?
# summarise(
#   gram_stain = paste(gram_stain, collapse = ", "),
#   aerobic_status = paste(aerobic_status, collapse = ", "),
#   ID = paste(ID, collapse = ", ")
# )

# If we want to exactly match the values for abxidx
# bacdive_phenotypes <- bacdive_phenotypes %>%
#   mutate(gram_stain = case_when(gram_stain %in% "positive" ~ "Gram-positive",
#                                 gram_stain %in% "negative" ~ "Gram-negative"))
# this turns all the "variable" values for gram_stain into NA's


```

## bacdive_susceptibility

```{r}
bacdive_susceptibility <- tibble()
for (i in 1:length(list_holder)) {
  abx_df <-
    list_holder[[i]]$`Physiology and metabolism`$`antibiotic resistance`
  my_df <- tibble()
  
  if (!is.null(abx_df)) {
    if (!is.null(names(abx_df))) {
      #for when you have a single antibiotic entry since a longer list will not have a `names` attribute
      my_df[1, "ID"] <- list_holder[[i]]$General$`BacDive-ID`
      my_df[1, "taxon"] <-
        list_holder[[i]]$`Name and taxonomic classification`$species
      my_df[1, "rank"] <- "Species"
      my_df[1, "antibiotic"] <- abx_df$metabolite
      resistant <- abx_df$`is resistant`
      #there is probably a smarter way to do this
      sensitive <- abx_df$`is sensitive`
      if (!is.null(resistant)) {
        if (resistant %in% "yes") {
          #you can not test both at once because R will error
          my_df[1, "value"] <- "resistant"
        }
      }
      if (!is.null(sensitive)) {
        if (sensitive %in% "yes") {
          my_df[1, "value"] <- "susceptible"
        }
      }
    } else {
      for (j in 1:length(abx_df)) {
        my_df[j, "ID"] <- list_holder[[i]]$General$`BacDive-ID`
        my_df[j, "taxon"] <-
          list_holder[[i]]$`Name and taxonomic classification`$species
        my_df[j, "rank"] <- "Species"
        my_df[j, "antibiotic"] <- abx_df[[j]]$metabolite
        resistant <- abx_df[[j]]$`is resistant`
        sensitive <- abx_df[[j]]$`is sensitive`
        if (!is.null(resistant)) {
          if (resistant %in% "yes") {
            #you can not test both at once because R will error
            my_df[j, "value"] <- "resistant"
          }
        }
        if (!is.null(sensitive)) {
          if (sensitive %in% "yes") {
            my_df[j, "value"] <- "susceptible"
          }
        }
      }
    }
  }
  
  bacdive_susceptibility <- bind_rows(bacdive_susceptibility, my_df)
  
}

attr(bacdive_susceptibility, "date_downloaded") <-
  attr(list_holder, "date_downloaded")
usethis::use_data(bacdive_susceptibility, overwrite = TRUE)
```

## bacdive_enzymes

```{r}
bacdive_enzymes <- tibble()
for (i in 1:length(list_holder)) {
  if (!is.null(list_holder[[i]]$`Physiology and metabolism`$enzymes)) {
    ref_df <-
      bind_rows(list_holder[[i]]$Reference) %>% select(`@id`, `doi/url`)
    enzyme_df <-
      bind_rows(list_holder[[i]]$`Physiology and metabolism`$enzymes) %>%
      mutate(
        ID = list_holder[[i]]$General$`BacDive-ID`,
        taxon = list_holder[[i]]$`Name and taxonomic classification`$species,
        rank = "Species"
      ) %>%
      left_join(ref_df, by = c("@ref" = "@id"))
    bacdive_enzymes <- bind_rows(bacdive_enzymes, enzyme_df)
  }
}

bacdive_enzymes %<>%
  select(ID, taxon, rank, activity, value, ec, doi = `doi/url`)
attr(bacdive_enzymes, "date_downloaded") <-
  attr(list_holder, "date_downloaded")
usethis::use_data(bacdive_enzymes, overwrite = TRUE)
```

## Shen2021

```{r}
Shen2021 <- read_csv("data-raw/Shen2021.csv", show_col_types = FALSE)
usethis::use_data(Shen2021, overwrite = TRUE)
```

# The end

